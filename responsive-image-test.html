<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>響應式圖片測試 - Image Transform Worker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .test-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            background: #34495e;
            color: white;
            padding: 20px;
        }

        .section-header h2 {
            margin-bottom: 5px;
        }

        .section-header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .section-content {
            padding: 30px;
        }

        /* Ghost 風格的圖片卡片 */
        .kg-card {
            margin: 30px 0;
        }

        .kg-image-card {
            position: relative;
        }

        .kg-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }

        .kg-image:hover {
            transform: scale(1.02);
        }

        /* 調試資訊 */
        .debug-info {
            background: #ecf0f1;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .debug-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .debug-info code {
            background: #d5dbdb;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* 視窗尺寸指示器 */
        .viewport-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* 圖片載入狀態 */
        .loading-placeholder {
            background: #ecf0f1;
            border-radius: 8px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* 響應式斷點測試區域 */
        .breakpoint-test {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .breakpoint-item {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .breakpoint-item h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .breakpoint-item .size-info {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        /* 手機版樣式 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .section-content {
                padding: 20px;
            }
        }

        /* 載入動畫 */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* 錯誤狀態 */
        .error-state {
            background: #fee;
            border: 1px solid #fcc;
            color: #c66;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="viewport-indicator" id="viewportIndicator">
        Loading...
    </div>

    <div class="container">
        <div class="header">
            <h1>🖼️ 響應式圖片測試工具</h1>
            <p>測試 Image Transform Worker 的響應式圖片在不同瀏覽器尺寸下的表現</p>
        </div>

        <!-- 主要測試圖片 -->
        <div class="test-section">
            <div class="section-header">
                <h2>主要測試圖片</h2>
                <p>您提供的 Ghost 風格響應式圖片測試</p>
            </div>
            <div class="section-content">
                <figure class="kg-card kg-image-card">
                    <img 
                        src="https://happylee.blog/img-cgi/768/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                        srcset="https://happylee.blog/img-cgi/320/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 320w, https://happylee.blog/img-cgi/480/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 480w, https://happylee.blog/img-cgi/640/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 640w, https://happylee.blog/img-cgi/768/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 768w, https://happylee.blog/img-cgi/960/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 960w, https://happylee.blog/img-cgi/1280/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 1280w, https://happylee.blog/img-cgi/1920/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 1920w" 
                        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px" 
                        class="kg-image" 
                        alt="Pasted image 20250812073523" 
                        loading="lazy" 
                        width="100%" 
                        data-action="zoom"
                        id="mainTestImage"
                        onload="updateImageInfo('mainTestImage')"
                        onerror="handleImageError('mainTestImage')"
                    >
                </figure>

                <div class="debug-info">
                    <h4>🔍 目前載入的圖片資訊</h4>
                    <div id="mainImageInfo">載入中...</div>
                </div>
            </div>
        </div>

        <!-- 各尺寸對比測試 -->
        <div class="test-section">
            <div class="section-header">
                <h2>各尺寸對比測試</h2>
                <p>直接比較不同尺寸的圖片載入效果</p>
            </div>
            <div class="section-content">
                <div class="breakpoint-test">
                    <div class="breakpoint-item">
                        <h4>📱 手機 (320px)</h4>
                        <div class="size-info">適用於小螢幕設備</div>
                        <img 
                            src="https://happylee.blog/img-cgi/320/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="320px version" 
                            style="max-width: 320px; width: 100%;"
                            onload="updateImageInfo('img320')"
                            onerror="handleImageError('img320')"
                            id="img320"
                        >
                        <div class="debug-info">
                            <div id="img320Info">載入中...</div>
                        </div>
                    </div>

                    <div class="breakpoint-item">
                        <h4>📱 大手機 (480px)</h4>
                        <div class="size-info">大螢幕手機或小平板</div>
                        <img 
                            src="https://happylee.blog/img-cgi/480/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="480px version" 
                            style="max-width: 480px; width: 100%;"
                            onload="updateImageInfo('img480')"
                            onerror="handleImageError('img480')"
                            id="img480"
                        >
                        <div class="debug-info">
                            <div id="img480Info">載入中...</div>
                        </div>
                    </div>

                    <div class="breakpoint-item">
                        <h4>💻 平板 (768px)</h4>
                        <div class="size-info">平板或小筆電</div>
                        <img 
                            src="https://happylee.blog/img-cgi/768/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="768px version" 
                            style="max-width: 768px; width: 100%;"
                            onload="updateImageInfo('img768')"
                            onerror="handleImageError('img768')"
                            id="img768"
                        >
                        <div class="debug-info">
                            <div id="img768Info">載入中...</div>
                        </div>
                    </div>

                    <div class="breakpoint-item">
                        <h4>🖥️ 桌機 (1280px)</h4>
                        <div class="size-info">桌面電腦或大螢幕</div>
                        <img 
                            src="https://happylee.blog/img-cgi/1280/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="1280px version" 
                            style="max-width: 1280px; width: 100%;"
                            onload="updateImageInfo('img1280')"
                            onerror="handleImageError('img1280')"
                            id="img1280"
                        >
                        <div class="debug-info">
                            <div id="img1280Info">載入中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 網路狀況測試 -->
        <div class="test-section">
            <div class="section-header">
                <h2>網路狀況測試</h2>
                <p>模擬不同網路環境下的載入表現</p>
            </div>
            <div class="section-content">
                <p>請開啟瀏覽器開發者工具 (F12) → Network 標籤，可以：</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>選擇不同的網路速度模擬 (Fast 3G, Slow 3G 等)</li>
                    <li>觀察不同尺寸圖片的載入時間</li>
                    <li>檢查實際載入的圖片 URL 和檔案大小</li>
                    <li>確認快取狀況 (304 Not Modified)</li>
                </ul>
                
                <button onclick="reloadAllImages()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0;">
                    🔄 重新載入所有圖片
                </button>
            </div>
        </div>

        <!-- 瀏覽器支援測試 -->
        <div class="test-section">
            <div class="section-header">
                <h2>瀏覽器支援測試</h2>
                <p>檢查不同格式的支援狀況</p>
            </div>
            <div class="section-content">
                <div id="browserSupport">檢查中...</div>
            </div>
        </div>
    </div>

    <script>
        // 更新視窗尺寸指示器
        function updateViewportIndicator() {
            const indicator = document.getElementById('viewportIndicator');
            const width = window.innerWidth;
            const height = window.innerHeight;
            const devicePixelRatio = window.devicePixelRatio || 1;
            
            let breakpoint = '';
            if (width <= 320) breakpoint = '📱 極小';
            else if (width <= 480) breakpoint = '📱 小';
            else if (width <= 768) breakpoint = '📱 中';
            else if (width <= 1024) breakpoint = '💻 平板';
            else if (width <= 1200) breakpoint = '💻 小桌機';
            else breakpoint = '🖥️ 大桌機';
            
            indicator.innerHTML = `
                ${breakpoint}<br>
                ${width} × ${height}<br>
                DPR: ${devicePixelRatio}
            `;
        }

        // 更新圖片資訊
        function updateImageInfo(imageId) {
            const img = document.getElementById(imageId);
            const infoDiv = document.getElementById(imageId + 'Info');
            
            if (img && infoDiv) {
                const naturalWidth = img.naturalWidth;
                const naturalHeight = img.naturalHeight;
                const displayWidth = img.offsetWidth;
                const displayHeight = img.offsetHeight;
                const src = img.currentSrc || img.src;
                
                // 提取 URL 中的尺寸資訊
                const sizeMatch = src.match(/img-cgi\/(\d+)/);
                const requestedSize = sizeMatch ? sizeMatch[1] + 'px' : '未知';
                
                infoDiv.innerHTML = `
                    <strong>載入成功</strong><br>
                    請求尺寸: <code>${requestedSize}</code><br>
                    實際尺寸: <code>${naturalWidth} × ${naturalHeight}</code><br>
                    顯示尺寸: <code>${displayWidth} × ${displayHeight}</code><br>
                    載入 URL: <code>${src.split('/').pop()}</code>
                `;
            }
        }

        // 處理圖片載入錯誤
        function handleImageError(imageId) {
            const infoDiv = document.getElementById(imageId + 'Info');
            if (infoDiv) {
                infoDiv.innerHTML = `
                    <div class="error-state">
                        ❌ 圖片載入失敗<br>
                        可能原因：檔案不存在、網路問題或伺服器錯誤
                    </div>
                `;
            }
        }

        // 重新載入所有圖片
        function reloadAllImages() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                const src = img.src;
                img.src = '';
                setTimeout(() => {
                    img.src = src + (src.includes('?') ? '&' : '?') + 'reload=' + Date.now();
                }, 100);
            });
        }

        // 檢查瀏覽器格式支援
        function checkBrowserSupport() {
            const supportDiv = document.getElementById('browserSupport');
            const formats = [
                { name: 'WebP', mime: 'image/webp' },
                { name: 'AVIF', mime: 'image/avif' },
                { name: 'JPEG XL', mime: 'image/jxl' }
            ];
            
            let html = '<div style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
            
            formats.forEach(format => {
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                
                const supported = canvas.toDataURL(format.mime).indexOf(format.mime) > -1;
                const status = supported ? '✅ 支援' : '❌ 不支援';
                const color = supported ? '#27ae60' : '#e74c3c';
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${color};">
                        <strong>${format.name}</strong><br>
                        ${status}
                    </div>
                `;
            });
            
            html += '</div>';
            
            // 添加用戶代理資訊
            html += `
                <div class="debug-info" style="margin-top: 20px;">
                    <h4>瀏覽器資訊</h4>
                    <strong>User Agent:</strong><br>
                    <code style="word-break: break-all;">${navigator.userAgent}</code>
                </div>
            `;
            
            supportDiv.innerHTML = html;
        }

        // 初始化
        window.addEventListener('load', () => {
            updateViewportIndicator();
            checkBrowserSupport();
        });

        window.addEventListener('resize', updateViewportIndicator);

        // 監聽圖片載入狀態
        document.addEventListener('DOMContentLoaded', () => {
            const images = document.querySelectorAll('img[id]');
            images.forEach(img => {
                if (img.complete) {
                    updateImageInfo(img.id);
                }
            });
        });

        // 添加效能監控
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const entries = performance.getEntriesByType('resource');
                    const imageEntries = entries.filter(entry => 
                        entry.name.includes('img-cgi') && entry.name.includes('image')
                    );
                    
                    if (imageEntries.length > 0) {
                        console.group('🖼️ 圖片載入效能分析');
                        imageEntries.forEach(entry => {
                            console.log(`${entry.name.split('/').pop()}: ${Math.round(entry.duration)}ms`);
                        });
                        console.groupEnd();
                    }
                }, 2000);
            });
        }
    </script>
</body>
</html>
