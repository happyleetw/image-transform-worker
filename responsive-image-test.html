<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ¿æ‡‰å¼åœ–ç‰‡æ¸¬è©¦ - Image Transform Worker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .test-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            background: #34495e;
            color: white;
            padding: 20px;
        }

        .section-header h2 {
            margin-bottom: 5px;
        }

        .section-header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .section-content {
            padding: 30px;
        }

        /* Ghost é¢¨æ ¼çš„åœ–ç‰‡å¡ç‰‡ */
        .kg-card {
            margin: 30px 0;
        }

        .kg-image-card {
            position: relative;
        }

        .kg-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }

        .kg-image:hover {
            transform: scale(1.02);
        }

        /* èª¿è©¦è³‡è¨Š */
        .debug-info {
            background: #ecf0f1;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .debug-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .debug-info code {
            background: #d5dbdb;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* è¦–çª—å°ºå¯¸æŒ‡ç¤ºå™¨ */
        .viewport-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(52, 73, 94, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* åœ–ç‰‡è¼‰å…¥ç‹€æ…‹ */
        .loading-placeholder {
            background: #ecf0f1;
            border-radius: 8px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-size: 14px;
        }

        /* éŸ¿æ‡‰å¼æ–·é»æ¸¬è©¦å€åŸŸ */
        .breakpoint-test {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .breakpoint-item {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .breakpoint-item h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .breakpoint-item .size-info {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .section-content {
                padding: 20px;
            }
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* éŒ¯èª¤ç‹€æ…‹ */
        .error-state {
            background: #fee;
            border: 1px solid #fcc;
            color: #c66;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="viewport-indicator" id="viewportIndicator">
        Loading...
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ–¼ï¸ éŸ¿æ‡‰å¼åœ–ç‰‡æ¸¬è©¦å·¥å…·</h1>
            <p>æ¸¬è©¦ Image Transform Worker çš„éŸ¿æ‡‰å¼åœ–ç‰‡åœ¨ä¸åŒç€è¦½å™¨å°ºå¯¸ä¸‹çš„è¡¨ç¾</p>
        </div>

        <!-- ä¸»è¦æ¸¬è©¦åœ–ç‰‡ -->
        <div class="test-section">
            <div class="section-header">
                <h2>ä¸»è¦æ¸¬è©¦åœ–ç‰‡</h2>
                <p>æ‚¨æä¾›çš„ Ghost é¢¨æ ¼éŸ¿æ‡‰å¼åœ–ç‰‡æ¸¬è©¦</p>
            </div>
            <div class="section-content">
                <figure class="kg-card kg-image-card">
                    <img 
                        src="https://happylee.blog/img-cgi/768/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                        srcset="https://happylee.blog/img-cgi/320/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 320w, https://happylee.blog/img-cgi/480/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 480w, https://happylee.blog/img-cgi/640/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 640w, https://happylee.blog/img-cgi/768/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 768w, https://happylee.blog/img-cgi/960/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 960w, https://happylee.blog/img-cgi/1280/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 1280w, https://happylee.blog/img-cgi/1920/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png 1920w" 
                        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px" 
                        class="kg-image" 
                        alt="Pasted image 20250812073523" 
                        loading="lazy" 
                        width="100%" 
                        data-action="zoom"
                        id="mainTestImage"
                        onload="updateImageInfo('mainTestImage')"
                        onerror="handleImageError('mainTestImage')"
                    >
                </figure>

                <div class="debug-info">
                    <h4>ğŸ” ç›®å‰è¼‰å…¥çš„åœ–ç‰‡è³‡è¨Š</h4>
                    <div id="mainImageInfo">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å„å°ºå¯¸å°æ¯”æ¸¬è©¦ -->
        <div class="test-section">
            <div class="section-header">
                <h2>å„å°ºå¯¸å°æ¯”æ¸¬è©¦</h2>
                <p>ç›´æ¥æ¯”è¼ƒä¸åŒå°ºå¯¸çš„åœ–ç‰‡è¼‰å…¥æ•ˆæœ</p>
            </div>
            <div class="section-content">
                <div class="breakpoint-test">
                    <div class="breakpoint-item">
                        <h4>ğŸ“± æ‰‹æ©Ÿ (320px)</h4>
                        <div class="size-info">é©ç”¨æ–¼å°è¢å¹•è¨­å‚™</div>
                        <img 
                            src="https://happylee.blog/img-cgi/320/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="320px version" 
                            style="max-width: 320px; width: 100%;"
                            onload="updateImageInfo('img320')"
                            onerror="handleImageError('img320')"
                            id="img320"
                        >
                        <div class="debug-info">
                            <div id="img320Info">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>

                    <div class="breakpoint-item">
                        <h4>ğŸ“± å¤§æ‰‹æ©Ÿ (480px)</h4>
                        <div class="size-info">å¤§è¢å¹•æ‰‹æ©Ÿæˆ–å°å¹³æ¿</div>
                        <img 
                            src="https://happylee.blog/img-cgi/480/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="480px version" 
                            style="max-width: 480px; width: 100%;"
                            onload="updateImageInfo('img480')"
                            onerror="handleImageError('img480')"
                            id="img480"
                        >
                        <div class="debug-info">
                            <div id="img480Info">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>

                    <div class="breakpoint-item">
                        <h4>ğŸ’» å¹³æ¿ (768px)</h4>
                        <div class="size-info">å¹³æ¿æˆ–å°ç­†é›»</div>
                        <img 
                            src="https://happylee.blog/img-cgi/768/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="768px version" 
                            style="max-width: 768px; width: 100%;"
                            onload="updateImageInfo('img768')"
                            onerror="handleImageError('img768')"
                            id="img768"
                        >
                        <div class="debug-info">
                            <div id="img768Info">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>

                    <div class="breakpoint-item">
                        <h4>ğŸ–¥ï¸ æ¡Œæ©Ÿ (1280px)</h4>
                        <div class="size-info">æ¡Œé¢é›»è…¦æˆ–å¤§è¢å¹•</div>
                        <img 
                            src="https://happylee.blog/img-cgi/1280/watermark/Publish/2025/08/12/Pasted%20image%2020250812073523.png" 
                            alt="1280px version" 
                            style="max-width: 1280px; width: 100%;"
                            onload="updateImageInfo('img1280')"
                            onerror="handleImageError('img1280')"
                            id="img1280"
                        >
                        <div class="debug-info">
                            <div id="img1280Info">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¶²è·¯ç‹€æ³æ¸¬è©¦ -->
        <div class="test-section">
            <div class="section-header">
                <h2>ç¶²è·¯ç‹€æ³æ¸¬è©¦</h2>
                <p>æ¨¡æ“¬ä¸åŒç¶²è·¯ç’°å¢ƒä¸‹çš„è¼‰å…¥è¡¨ç¾</p>
            </div>
            <div class="section-content">
                <p>è«‹é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) â†’ Network æ¨™ç±¤ï¼Œå¯ä»¥ï¼š</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>é¸æ“‡ä¸åŒçš„ç¶²è·¯é€Ÿåº¦æ¨¡æ“¬ (Fast 3G, Slow 3G ç­‰)</li>
                    <li>è§€å¯Ÿä¸åŒå°ºå¯¸åœ–ç‰‡çš„è¼‰å…¥æ™‚é–“</li>
                    <li>æª¢æŸ¥å¯¦éš›è¼‰å…¥çš„åœ–ç‰‡ URL å’Œæª”æ¡ˆå¤§å°</li>
                    <li>ç¢ºèªå¿«å–ç‹€æ³ (304 Not Modified)</li>
                </ul>
                
                <button onclick="reloadAllImages()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0;">
                    ğŸ”„ é‡æ–°è¼‰å…¥æ‰€æœ‰åœ–ç‰‡
                </button>
            </div>
        </div>

        <!-- ç€è¦½å™¨æ”¯æ´æ¸¬è©¦ -->
        <div class="test-section">
            <div class="section-header">
                <h2>ç€è¦½å™¨æ”¯æ´æ¸¬è©¦</h2>
                <p>æª¢æŸ¥ä¸åŒæ ¼å¼çš„æ”¯æ´ç‹€æ³</p>
            </div>
            <div class="section-content">
                <div id="browserSupport">æª¢æŸ¥ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // æ›´æ–°è¦–çª—å°ºå¯¸æŒ‡ç¤ºå™¨
        function updateViewportIndicator() {
            const indicator = document.getElementById('viewportIndicator');
            const width = window.innerWidth;
            const height = window.innerHeight;
            const devicePixelRatio = window.devicePixelRatio || 1;
            
            let breakpoint = '';
            if (width <= 320) breakpoint = 'ğŸ“± æ¥µå°';
            else if (width <= 480) breakpoint = 'ğŸ“± å°';
            else if (width <= 768) breakpoint = 'ğŸ“± ä¸­';
            else if (width <= 1024) breakpoint = 'ğŸ’» å¹³æ¿';
            else if (width <= 1200) breakpoint = 'ğŸ’» å°æ¡Œæ©Ÿ';
            else breakpoint = 'ğŸ–¥ï¸ å¤§æ¡Œæ©Ÿ';
            
            indicator.innerHTML = `
                ${breakpoint}<br>
                ${width} Ã— ${height}<br>
                DPR: ${devicePixelRatio}
            `;
        }

        // æ›´æ–°åœ–ç‰‡è³‡è¨Š
        function updateImageInfo(imageId) {
            const img = document.getElementById(imageId);
            const infoDiv = document.getElementById(imageId + 'Info');
            
            if (img && infoDiv) {
                const naturalWidth = img.naturalWidth;
                const naturalHeight = img.naturalHeight;
                const displayWidth = img.offsetWidth;
                const displayHeight = img.offsetHeight;
                const src = img.currentSrc || img.src;
                
                // æå– URL ä¸­çš„å°ºå¯¸è³‡è¨Š
                const sizeMatch = src.match(/img-cgi\/(\d+)/);
                const requestedSize = sizeMatch ? sizeMatch[1] + 'px' : 'æœªçŸ¥';
                
                infoDiv.innerHTML = `
                    <strong>è¼‰å…¥æˆåŠŸ</strong><br>
                    è«‹æ±‚å°ºå¯¸: <code>${requestedSize}</code><br>
                    å¯¦éš›å°ºå¯¸: <code>${naturalWidth} Ã— ${naturalHeight}</code><br>
                    é¡¯ç¤ºå°ºå¯¸: <code>${displayWidth} Ã— ${displayHeight}</code><br>
                    è¼‰å…¥ URL: <code>${src.split('/').pop()}</code>
                `;
            }
        }

        // è™•ç†åœ–ç‰‡è¼‰å…¥éŒ¯èª¤
        function handleImageError(imageId) {
            const infoDiv = document.getElementById(imageId + 'Info');
            if (infoDiv) {
                infoDiv.innerHTML = `
                    <div class="error-state">
                        âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—<br>
                        å¯èƒ½åŸå› ï¼šæª”æ¡ˆä¸å­˜åœ¨ã€ç¶²è·¯å•é¡Œæˆ–ä¼ºæœå™¨éŒ¯èª¤
                    </div>
                `;
            }
        }

        // é‡æ–°è¼‰å…¥æ‰€æœ‰åœ–ç‰‡
        function reloadAllImages() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                const src = img.src;
                img.src = '';
                setTimeout(() => {
                    img.src = src + (src.includes('?') ? '&' : '?') + 'reload=' + Date.now();
                }, 100);
            });
        }

        // æª¢æŸ¥ç€è¦½å™¨æ ¼å¼æ”¯æ´
        function checkBrowserSupport() {
            const supportDiv = document.getElementById('browserSupport');
            const formats = [
                { name: 'WebP', mime: 'image/webp' },
                { name: 'AVIF', mime: 'image/avif' },
                { name: 'JPEG XL', mime: 'image/jxl' }
            ];
            
            let html = '<div style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">';
            
            formats.forEach(format => {
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                
                const supported = canvas.toDataURL(format.mime).indexOf(format.mime) > -1;
                const status = supported ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
                const color = supported ? '#27ae60' : '#e74c3c';
                
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid ${color};">
                        <strong>${format.name}</strong><br>
                        ${status}
                    </div>
                `;
            });
            
            html += '</div>';
            
            // æ·»åŠ ç”¨æˆ¶ä»£ç†è³‡è¨Š
            html += `
                <div class="debug-info" style="margin-top: 20px;">
                    <h4>ç€è¦½å™¨è³‡è¨Š</h4>
                    <strong>User Agent:</strong><br>
                    <code style="word-break: break-all;">${navigator.userAgent}</code>
                </div>
            `;
            
            supportDiv.innerHTML = html;
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateViewportIndicator();
            checkBrowserSupport();
        });

        window.addEventListener('resize', updateViewportIndicator);

        // ç›£è½åœ–ç‰‡è¼‰å…¥ç‹€æ…‹
        document.addEventListener('DOMContentLoaded', () => {
            const images = document.querySelectorAll('img[id]');
            images.forEach(img => {
                if (img.complete) {
                    updateImageInfo(img.id);
                }
            });
        });

        // æ·»åŠ æ•ˆèƒ½ç›£æ§
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const entries = performance.getEntriesByType('resource');
                    const imageEntries = entries.filter(entry => 
                        entry.name.includes('img-cgi') && entry.name.includes('image')
                    );
                    
                    if (imageEntries.length > 0) {
                        console.group('ğŸ–¼ï¸ åœ–ç‰‡è¼‰å…¥æ•ˆèƒ½åˆ†æ');
                        imageEntries.forEach(entry => {
                            console.log(`${entry.name.split('/').pop()}: ${Math.round(entry.duration)}ms`);
                        });
                        console.groupEnd();
                    }
                }, 2000);
            });
        }
    </script>
</body>
</html>
